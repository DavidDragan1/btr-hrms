{"version":3,"file":"abstract-cache.service.js","sourceRoot":"","sources":["../../../../../../../packages/desktop-ui-lib/src/lib/services/abstract-cache.service.ts"],"names":[],"mappings":";;;AAAA,iCAAiC;AAIjC,qCAA2B;AAE3B,MAAsB,oBAAoB;IAQzC,YACW,eAAkC,EAClC,MAAa;QADb,oBAAe,GAAf,eAAe,CAAmB;QAClC,WAAM,GAAN,MAAM,CAAO;QATP,iBAAY,GAAG,SAAS,CAAC;QAGlC,WAAM,GAEV,EAAE,CAAC;QAMN,IAAI,CAAC,SAAS,GAAG,GAAG,CAAC,CAAC,wCAAwC;QAC9D,IAAI,CAAC,OAAO,GAAG,EAAE,CAAC;IACnB,CAAC;IAEM,QAAQ,CAAC,MAAY;QAC3B,MAAM,GAAG,GAAG,MAAM;YACjB,CAAC,CAAC,IAAI,CAAC,MAAM,CAAC,MAAM,CAAC,IAAA,iBAAI,EAAC,MAAM,CAAC,CAAC,QAAQ,EAAE,CAAC;YAC7C,CAAC,CAAC,IAAI,CAAC,YAAY,CAAC;QACrB,MAAM,IAAI,GAAG,IAAI,CAAC,MAAM,CAAC,GAAG,CAAC;YAC5B,CAAC,CAAC,IAAI,CAAC,MAAM,CAAC,GAAG,CAAC;YAClB,CAAC,CAAC,IAAI,CAAC,eAAe,CAAC,OAAO,CAAC,GAAG,CAAC,CAAC;QAErC,IAAI,CAAC,IAAI,EAAE;YACV,OAAO,IAAI,CAAC;SACZ;QACD,IAAI,IAAI,CAAC,MAAM,CAAC,SAAS,EAAE;YAC1B;;eAEG;SACH;aAAM,IAAI,MAAM,CAAC,IAAI,IAAI,EAAE,CAAC,CAAC,OAAO,CAAC,IAAI,CAAC,SAAS,CAAC,EAAE;YACtD,OAAO,IAAI,CAAC;SACZ;QACD,OAAO,IAAI,CAAC,KAAK,CAAC;IACnB,CAAC;IAEM,QAAQ,CAAC,KAAoB,EAAE,MAAY;QACjD,MAAM,GAAG,GAAG,MAAM;YACjB,CAAC,CAAC,IAAI,CAAC,MAAM,CAAC,MAAM,CAAC,IAAA,iBAAI,EAAC,MAAM,CAAC,CAAC,QAAQ,EAAE,CAAC;YAC7C,CAAC,CAAC,IAAI,CAAC,YAAY,CAAC;QACrB,MAAM,SAAS,GAAG,MAAM,CAAC,IAAI,IAAI,EAAE,CAAC;aAClC,GAAG,CAAC,IAAI,CAAC,SAAS,EAAE,cAAc,CAAC;aACnC,MAAM,EAAE,CAAC;QACX,IAAI,CAAC,MAAM,CAAC,GAAG,CAAC,GAAG,EAAE,SAAS,EAAE,KAAK,EAAE,CAAC;QACxC,IAAI,CAAC,eAAe,CAAC,OAAO,CAAC,EAAE,GAAG,EAAE,KAAK,EAAE,IAAI,CAAC,MAAM,CAAC,GAAG,CAAC,EAAE,CAAC,CAAC;IAChE,CAAC;IAEM,KAAK;QACX,IAAI,CAAC,MAAM,GAAG,EAAE,CAAC;QACjB,IAAI,CAAC,eAAe,CAAC,UAAU,EAAE,CAAC,OAAO,CAAC,CAAC,GAAW,EAAE,EAAE;YACzD,IAAI,GAAG,CAAC,QAAQ,CAAC,IAAI,CAAC,MAAM,CAAC,EAAE;gBAC9B,IAAI,CAAC,eAAe,CAAC,UAAU,CAAC,GAAG,CAAC,CAAC;aACrC;QACF,CAAC,CAAC,CAAC;IACJ,CAAC;IAED,IAAc,QAAQ;QACrB,OAAO,IAAI,CAAC,SAAS,CAAC;IACvB,CAAC;IAED,IAAc,QAAQ,CAAC,KAAa;QACnC,IAAI,CAAC,SAAS,GAAG,KAAK,CAAC;IACxB,CAAC;IAED,IAAc,MAAM;QACnB,OAAO,IAAI,CAAC,OAAO,CAAC;IACrB,CAAC;IAED,IAAc,MAAM,CAAC,KAAa;QACjC,IAAI,CAAC,OAAO,GAAG,IAAA,iBAAI,EAAC,KAAK,CAAC,CAAC,QAAQ,EAAE,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC;IACnD,CAAC;CACD;AAxED,oDAwEC","sourcesContent":["import * as moment from 'moment';\r\nimport { Observable } from 'rxjs';\r\nimport { ICache, StorageService } from './storage.service';\r\nimport { Store } from '../services';\r\nimport hash from 'hash-it';\r\n\r\nexport abstract class AbstractCacheService<T> {\r\n\tprivate readonly _DEFAULT_KEY = 'DEFAULT';\r\n\tprivate _duration: number; // Cache duration value in minutes;\r\n\tprivate _prefix: string;\r\n\tprivate _cache: {\r\n\t\t[id: string]: ICache<T>;\r\n\t} = {};\r\n\r\n\tconstructor(\r\n\t\tprotected _storageService: StorageService<T>,\r\n\t\tprotected _store: Store\r\n\t) {\r\n\t\tthis._duration = 500; // Default cache set to 500 milliseconds\r\n\t\tthis._prefix = '';\r\n\t}\r\n\r\n\tpublic getValue(object?: any): Observable<T> {\r\n\t\tconst key = object\r\n\t\t\t? this.prefix.concat(hash(object).toString())\r\n\t\t\t: this._DEFAULT_KEY;\r\n\t\tconst item = this._cache[key]\r\n\t\t\t? this._cache[key]\r\n\t\t\t: this._storageService.getItem(key);\r\n\r\n\t\tif (!item) {\r\n\t\t\treturn null;\r\n\t\t}\r\n\t\tif (this._store.isOffline) {\r\n\t\t\t/*\r\n\t\t\t^_^ Ignore expire date\r\n\t\t\t */\r\n\t\t} else if (moment(new Date()).isAfter(item.expiresAt)) {\r\n\t\t\treturn null;\r\n\t\t}\r\n\t\treturn item.value;\r\n\t}\r\n\r\n\tpublic setValue(value: Observable<T>, object?: any) {\r\n\t\tconst key = object\r\n\t\t\t? this.prefix.concat(hash(object).toString())\r\n\t\t\t: this._DEFAULT_KEY;\r\n\t\tconst expiresAt = moment(new Date())\r\n\t\t\t.add(this._duration, 'milliseconds')\r\n\t\t\t.toDate();\r\n\t\tthis._cache[key] = { expiresAt, value };\r\n\t\tthis._storageService.setItem({ key, cache: this._cache[key] });\r\n\t}\r\n\r\n\tpublic clear() {\r\n\t\tthis._cache = {};\r\n\t\tthis._storageService.getAllKeys().forEach((key: string) => {\r\n\t\t\tif (key.includes(this.prefix)) {\r\n\t\t\t\tthis._storageService.removeItem(key);\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tprotected get duration(): number {\r\n\t\treturn this._duration;\r\n\t}\r\n\r\n\tprotected set duration(value: number) {\r\n\t\tthis._duration = value;\r\n\t}\r\n\r\n\tprotected get prefix(): string {\r\n\t\treturn this._prefix;\r\n\t}\r\n\r\n\tprotected set prefix(value: string) {\r\n\t\tthis._prefix = hash(value).toString().concat('_');\r\n\t}\r\n}\r\n"]}